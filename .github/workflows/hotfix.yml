name: Reusable Hotfix Workflow

on:
  workflow_call:
    inputs:
      version_type:
        description: "Version type (major, minor, patch)"
        required: true
        type: string
      main_branch:
        description: "Production branch name"
        required: false
        type: string
        default: "main"
      package_file:
        description: "Package file path"
        required: false
        type: string
        default: "package.json"
      package_lock:
        description: "Package lock file path"
        required: false
        type: string
        default: "package-lock.json"
      bot_name:
        description: "Git bot name"
        required: false
        type: string
        default: "github-actions[bot]"
      bot_email:
        description: "Git bot email"
        required: false
        type: string
        default: "github-actions[bot]@users.noreply.github.com"

permissions:
  contents: write
  pull-requests: write

jobs:
  create-hotfix-pr:
    name: Create Hotfix PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.main_branch }}

      - name: Configure Git
        run: |
          git config user.name "${{ inputs.bot_name }}"
          git config user.email "${{ inputs.bot_email }}"

      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep '"version"' ${{ inputs.package_file }} | sed -E 's/.*"version":\s*"([^"]*)".*/\1/')
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: new_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          VERSION_TYPE="${{ inputs.version_type }}"

          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"

          case $VERSION_TYPE in
            major)
              NEW_VERSION="$((major+1)).0.0"
              ;;
            minor)
              NEW_VERSION="$major.$((minor+1)).0"
              ;;
            patch)
              NEW_VERSION="$major.$minor.$((patch+1))"
              ;;
          esac

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸš‘ Hotfix version will be: $NEW_VERSION"

      - name: Create hotfix branch
        run: |
          HOTFIX_BRANCH="hotfix/${{ steps.new_version.outputs.version }}"
          git checkout -b "$HOTFIX_BRANCH"
          echo "âœ… Created branch: $HOTFIX_BRANCH"

      - name: Update version in package.json
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          OLD_VERSION="${{ steps.current_version.outputs.version }}"

          echo "ðŸ“ Updating package.json version..."
          sed -i '3s/"version": "[^"]*"/"version": "'$NEW_VERSION'"/' ${{ inputs.package_file }}

          if [ -f "${{ inputs.package_lock }}" ]; then
            echo "ðŸ“ Updating package-lock.json version fields..."
            sed -i '3s/"version": "[^"]*"/"version": "'$NEW_VERSION'"/' ${{ inputs.package_lock }}
            sed -i '9s/"version": "[^"]*"/"version": "'$NEW_VERSION'"/' ${{ inputs.package_lock }}
          fi

          echo "âœ… Updated version to $NEW_VERSION"

      - name: Commit version bump
        run: |
          git add ${{ inputs.package_file }}
          if [ -f "${{ inputs.package_lock }}" ]; then
            git add ${{ inputs.package_lock }}
          fi
          git commit -m "chore: bump version to ${{ steps.new_version.outputs.version }}"
          echo "âœ… Committed version bump"

      - name: Push hotfix branch
        run: |
          git push origin "hotfix/${{ steps.new_version.outputs.version }}"
          echo "âœ… Pushed hotfix branch to remote"

      - name: Create Pull Request
        id: create_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d '{
              "title": "ðŸš‘ Hotfix v${{ steps.new_version.outputs.version }}",
              "head": "hotfix/${{ steps.new_version.outputs.version }}",
              "base": "${{ inputs.main_branch }}",
              "body": "## ðŸš‘ Hotfix v${{ steps.new_version.outputs.version }}\n\nThis PR contains the **${{ inputs.version_type }}** hotfix version bump from `${{ steps.current_version.outputs.version }}` to `${{ steps.new_version.outputs.version }}`.\n\n### What happens next?\n1. **Tests will run automatically** on this PR\n2. **Review and approve** when tests pass\n3. **Merge the PR** to trigger:\n   - Automatic tagging as v${{ steps.new_version.outputs.version }}\n   - Production deployment\n   - Sync PR from main â†’ stage\n\n---\n*This PR was automatically created by the hotfix workflow*"
            }')

          PR_NUMBER=$(echo "$PR_RESPONSE" | grep -o '"number":[[:space:]]*[0-9]*' | head -1 | sed 's/.*:[[:space:]]*//')
          PR_URL=$(echo "$PR_RESPONSE" | grep -o '"html_url":[[:space:]]*"[^"]*' | head -1 | cut -d'"' -f4)

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "âŒ Failed to create PR"
            echo "Response: $PR_RESPONSE"
            exit 1
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "âœ… Created PR #$PR_NUMBER"

      - name: Add release label to PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ensure labels exist (ignore if they already exist)
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/labels \
            -d '{"name": "release", "color": "0E8A16", "description": "Release PR"}' || true
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/labels \
            -d '{"name": "automated", "color": "EDEDED", "description": "Automated PR"}' || true

          # Add labels to the PR
          LABEL_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ steps.create_pr.outputs.pr_number }}/labels \
            -d '{"labels": ["release", "automated"]}')

          if echo "$LABEL_RESPONSE" | grep -q '"name":[[:space:]]*"release"'; then
            echo "âœ… Added release labels"
          else
            echo "âš ï¸ Warning: Could not add labels to PR"
            echo "Response: $LABEL_RESPONSE"
          fi

      - name: Summary
        run: |
          echo "## ðŸš‘ Hotfix PR Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Information" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Type** | ${{ inputs.version_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **From** | v${{ steps.current_version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **To** | v${{ steps.new_version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | hotfix/${{ steps.new_version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Request" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** [#${{ steps.create_pr.outputs.pr_number }}](${{ steps.create_pr.outputs.pr_url }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Open for review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. â³ Wait for tests to complete" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… Review and approve the PR" >> $GITHUB_STEP_SUMMARY
          echo "3. ðŸš€ Merge to trigger:" >> $GITHUB_STEP_SUMMARY
          echo "   - Automatic tagging" >> $GITHUB_STEP_SUMMARY
          echo "   - Production deployment" >> $GITHUB_STEP_SUMMARY
          echo "   - Sync PR from main â†’ stage" >> $GITHUB_STEP_SUMMARY
